name: Build pcsx_rearmed for GCW0 (mipsel)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install system dependencies
        run: |
          sudo apt update && sudo apt install -y wget tar make gcc git libmagic1 zlib1g-dev libpng-dev

      - name: Download and setup GCW0 toolchain
        run: |
          sudo mkdir -p /opt
          wget https://github.com/game-de-it/GKD_pixel/releases/download/GKDpixel-toolchain-v1/mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz -O /tmp/toolchain.tar.gz
          sudo tar zxvf /tmp/toolchain.tar.gz -C /opt/
          sudo mv /opt/mipsel-gcw0-linux-uclibc_sdk-buildroot /opt/gcw0-toolchain
          cd /opt/gcw0-toolchain
          sudo chmod +x relocate-sdk.sh
          sudo ./relocate-sdk.sh
          sudo chown -R $USER:$USER /opt/gcw0-toolchain
          # 验证工具链可用性
          /opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-gcc --version

      - name: Set environment variables (关键添加-I.头文件路径)
        run: |
          export CROSS_COMPILE=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-
          export SYSROOT=/opt/gcw0-toolchain/usr/mipsel-gcw0-linux-uclibc/sysroot
          export CC=${CROSS_COMPILE}gcc
          export CXX=${CROSS_COMPILE}g++
          export AR=${CROSS_COMPILE}ar
          export LD=${CROSS_COMPILE}ld
          export STRIP=${CROSS_COMPILE}strip
          
          # 核心修复：添加 -I. 让编译器从根目录搜索头文件（解决config.h路径问题）
          export CFLAGS="-O2 -ffast-math -march=mips32 -mtune=mips32r2 -mhard-float -fdata-sections -ffunction-sections --sysroot=${SYSROOT} -D_GNU_SOURCE=1 -I."
          export CXXFLAGS="${CFLAGS}"
          
          # 补充链接参数
          export LDFLAGS="-march=mips32 -mtune=mips32r2 -mhard-float --sysroot=${SYSROOT} -lpthread -lm -ldl -lz -Wl,--gc-sections"
          export LDLIBS="-lpthread -lm -ldl -lz"
          
          # 写入环境变量
          echo "CROSS_COMPILE=$CROSS_COMPILE" >> $GITHUB_ENV
          echo "SYSROOT=$SYSROOT" >> $GITHUB_ENV
          echo "CC=$CC" >> $GITHUB_ENV
          echo "CXX=$CXX" >> $GITHUB_ENV
          echo "AR=$AR" >> $GITHUB_ENV
          echo "LD=$LD" >> $GITHUB_ENV
          echo "STRIP=$STRIP" >> $GITHUB_ENV
          echo "CFLAGS=$CFLAGS" >> $GITHUB_ENV
          echo "CXXFLAGS=$CXXFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=$LDFLAGS" >> $GITHUB_ENV
          echo "LDLIBS=$LDLIBS" >> $GITHUB_ENV
          echo "/opt/gcw0-toolchain/usr/bin" >> $GITHUB_PATH

      - name: Checkout pcsx_rearmed source code
        uses: actions/checkout@v4
        with:
          repository: libretro/pcsx_rearmed
          path: pcsx_rearmed
          fetch-depth: 1

      - name: Prepare build environment (先clean再生成config.h)
        run: |
          cd pcsx_rearmed
          # 第一步：清理所有旧产物
          make -f Makefile.libretro clean || true
          
          # 第二步：生成config.h到根目录（验证生成路径）
          cat > config.h << EOF
          /* 架构宏（完整） */
          #define ARCH_MIPS 1
          #define ARCH_MIPSEL 1
          #define __mips__ 1
          #define __mipsel__ 1
          #define MIPS32 1
          #define MIPS32R2 1
          #define __mips_isa_rev 2
          
          /* libretro核心必备宏 */
          #define HAVE_LIBRETRO 1
          #define LIBRETRO 1
          
          /* 功能宏（启用完整模块） */
          #define DISABLE_THREADS 0
          #define SOUND_DRIVER_SDL 0
          #define SOUND_DRIVER_ALSA 0
          #define SOUND_DRIVER_OSS 0
          #define SOUND_DRIVER_PULSEAUDIO 0
          #define GPU_PEOPS 1
          #define GPU_PEOPS_MIPS 1
          #define DYNAREC_LIGHTREC 1
          #define DYNAREC_NONE 0
          #define HAVE_DYNAREC 1
          #define HAVE_FLOAT_EMU 1
          #define HAVE_CORE_COMPAT 1
          #define HAVE_CCD 1
          #define HAVE_CDR 1
          #define HAVE_CISO 1
          #define HAVE_CHD 1
          #define HAVE_PBP 1
          
          /* 系统宏 */
          #define SYSROOT "${{ env.SYSROOT }}"
          #define CROSS_COMPILE "${{ env.CROSS_COMPILE }}"
          #define HAVE_STDINT_H 1
          #define HAVE_STDLIB_H 1
          #define HAVE_STRING_H 1
          #define HAVE_UNISTD_H 1
          #define HAVE_INTTYPES_H 1
          #define HAVE_MEMCPY 1
          #define HAVE_MEMSET 1
          #define HAVE_STRCASECMP 1
          #define HAVE_STRNCASECMP 1
          #define HAVE_MALLOC 1
          #define HAVE_FREE 1
          #define HAVE_OPEN 1
          #define HAVE_CLOSE 1
          #define HAVE_READ 1
          #define HAVE_WRITE 1
          #define _GNU_SOURCE 1
          EOF
          
          # 验证：打印config.h路径和内容（排查生成问题）
          echo "✅ config.h生成路径：$(pwd)/config.h"
          ls -la config.h
          cat config.h | head -10  # 打印前10行验证内容
          
          # 确保权限正确
          chmod 644 config.h
          echo "✅ config.h 生成完成并验证"

      - name: Build pcsx_rearmed libretro core (完整编译参数)
        run: |
          cd pcsx_rearmed
          # 双重验证：config.h存在 + CFLAGS包含-I.
          if [ ! -f config.h ]; then
            echo "ERROR: config.h缺失，编译终止！"
            exit 1
          fi
          if [[ ! "${{ env.CFLAGS }}" =~ "-I." ]]; then
            echo "ERROR: CFLAGS未包含-I.，头文件路径错误！"
            exit 1
          fi
          
          # 显式传递所有参数编译
          make -f Makefile.libretro \
            PLATFORM=unix \
            ARCH=mipsel \
            HAVE_DYNAREC=1 \
            GPU=peops \
            CROSS_COMPILE=${{ env.CROSS_COMPILE }} \
            CC=${{ env.CC }} \
            CXX=${{ env.CXX }} \
            AR=${{ env.AR }} \
            LD=${{ env.LD }} \
            CFLAGS="${{ env.CFLAGS }}" \
            CXXFLAGS="${{ env.CXXFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}" \
            LDLIBS="${{ env.LDLIBS }}" \
            -j$(nproc)

      - name: Verify build result (检查体积)
        run: |
          cd pcsx_rearmed
          if [ -f pcsx_rearmed_libretro.so ]; then
            FILE_SIZE=$(du -h pcsx_rearmed_libretro.so | awk '{print $1}')
            echo "✅ 编译成功！产物路径：$(pwd)/pcsx_rearmed_libretro.so"
            echo "✅ 产物体积：$FILE_SIZE"
            file pcsx_rearmed_libretro.so || echo "⚠️ file命令验证跳过"
            if [[ $(du -k pcsx_rearmed_libretro.so | awk '{print $1}') -lt 1000 ]]; then
              echo "⚠️ 产物体积小于1MB，建议检查功能宏是否完整"
            fi
          else
            echo "ERROR: 编译产物缺失！"
            exit 1
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pcsx_rearmed-gcw0-core
          path: pcsx_rearmed/pcsx_rearmed_libretro.so
          retention-days: 30
