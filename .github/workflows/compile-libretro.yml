name: Build pcsx_rearmed for GCW0

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          wget \
          tar \
          gzip \
          make \
          autoconf \
          automake \
          libtool \
          pkg-config \
          libsdl1.2-dev \
          zlib1g-dev \
          libpng-dev
        
    - name: Setup GCW0 toolchain
      run: |
        sudo mkdir -p /opt
        sudo chmod 777 /opt
        
        cd /opt
        wget -q https://github.com/game-de-it/GKD_pixel/releases/download/GKDpixel-toolchain-v1/mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz
        tar zxf mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz
        mv mipsel-gcw0-linux-uclibc_sdk-buildroot gcw0-toolchain
        cd gcw0-toolchain
        ./relocate-sdk.sh
        
        # 设置环境变量
        export CROSS_COMPILE=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-
        export SYSROOT=/opt/gcw0-toolchain/usr/mipsel-gcw0-linux-uclibc/sysroot
        export CC=${CROSS_COMPILE}gcc
        export CXX=${CROSS_COMPILE}g++
        export AR=${CROSS_COMPILE}ar
        export LD=${CROSS_COMPILE}ld
        export STRIP=${CROSS_COMPILE}strip
        export RANLIB=${CROSS_COMPILE}ranlib
        
        echo "CROSS_COMPILE=${CROSS_COMPILE}" >> $GITHUB_ENV
        echo "SYSROOT=${SYSROOT}" >> $GITHUB_ENV
        echo "CC=${CC}" >> $GITHUB_ENV
        echo "CXX=${CXX}" >> $GITHUB_ENV
        echo "AR=${AR}" >> $GITHUB_ENV
        echo "LD=${LD}" >> $GITHUB_ENV
        echo "STRIP=${STRIP}" >> $GITHUB_ENV
        echo "RANLIB=${RANLIB}" >> $GITHUB_ENV
        echo "PATH=/opt/gcw0-toolchain/usr/bin:$PATH" >> $GITHUB_ENV
        
    - name: Clone and build pcsx_rearmed
      run: |
        # 克隆pcsx_rearmed
        git clone --depth=1 https://github.com/libretro/pcsx_rearmed.git
        cd pcsx_rearmed
        
        # 初始化子模块
        git submodule update --init --recursive
        
        # 设置编译标志
        export CFLAGS="-ffast-math -march=mips32 -mtune=mips32r2 -mhard-float -fdata-sections -ffunction-sections -O2"
        export CXXFLAGS="$CFLAGS"
        export LDFLAGS="-Wl,--gc-sections"
        
        echo "=== 尝试编译 pcsx_rearmed ==="
        
        # 方法1: 尝试使用libretro构建系统
        echo "尝试方法1: 使用 Makefile.libretro..."
        make -f Makefile.libretro platform=unix CC="${CC}" CXX="${CXX}" AR="${AR}" LD="${LD}" CFLAGS="${CFLAGS}" CXXFLAGS="${CXXFLAGS}" LDFLAGS="${LDFLAGS}" || \
        echo "方法1失败，继续尝试..."
        
        # 如果方法1失败，尝试方法2
        if [ ! -f "pcsx_rearmed_libretro.so" ]; then
          echo "尝试方法2: 手动编译..."
          # 简单的手动编译尝试
          ${CC} ${CFLAGS} -I. -Iinclude -Ilibpcsxcore -Ideps/libchdr/include -Ideps/libretro-common/include \
            -DDISABLE_MEM_LUTS=0 -DGPU_PEOPS -DHAVE_CHD -DHAVE_CDROM \
            -DUSE_LIBRETRO_VFS -DHAVE_LIBRETRO -DNO_FRONTEND \
            -DLIGHTREC -DLIGHTREC_STATIC \
            -Wall -O3 -fPIC -shared -o pcsx_rearmed_libretro.so \
            libpcsxcore/*.c frontend/libretro.c \
            -L${SYSROOT}/usr/lib -lz -lm || echo "手动编译也失败"
        fi
        
    - name: Check build output
      run: |
        echo "=== 检查编译输出 ==="
        
        # 创建输出目录
        mkdir -p output
        
        # 检查并复制任何可能的输出文件
        if [ -f "pcsx_rearmed/pcsx_rearmed_libretro.so" ]; then
          echo "✓ 找到 pcsx_rearmed_libretro.so"
          cp pcsx_rearmed/pcsx_rearmed_libretro.so output/
        else
          echo "✗ 未找到 pcsx_rearmed_libretro.so"
        fi
        
        # 查找其他可能的文件
        find pcsx_rearmed -name "*.so" -type f 2>/dev/null | while read file; do
          echo "找到文件: $file"
          cp "$file" output/ 2>/dev/null || true
        done
        
        # 如果没有找到任何文件，创建一个说明文件
        if [ ! "$(ls -A output/ 2>/dev/null)" ]; then
          echo "编译未生成任何文件" > output/NO_OUTPUT.txt
          echo "请检查编译步骤的日志" >> output/NO_OUTPUT.txt
        fi
        
        # 列出输出目录内容
        echo "输出目录内容:"
        ls -la output/ || echo "输出目录为空"
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pcsx-rearmed-gcw0
        path: output/
