name: Compile QuickNES MIPS32 Little Endian

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Install dependencies
        run: |
          sudo apt update -y
          sudo apt install -y gcc-mipsel-linux-gnu git

      - name: Clone QuickNES Core (with directory check)
        run: |
          # 克隆仓库并查看完整目录结构（调试关键）
          git clone --depth=1 https://github.com/libretro/QuickNES_Core.git
          echo "=== QuickNES_Core 目录结构 ==="
          tree -L 2 QuickNES_Core/  # 显示2级目录，直观看到src/inc目录
          echo "=== 所有C文件位置 ==="
          find QuickNES_Core/ -name "*.c"  # 列出所有.c文件的路径

      - name: Compile QuickNES Core for mips32el (fixed path)
        run: |
          cd QuickNES_Core
          # 编译命令修正：
          # 1. src/*.c：匹配src目录下的所有核心源码
          # 2. libretro.c：匹配根目录的libretro接口文件
          # 3. -Iinc：指定头文件目录（必须，否则找不到头文件）
          # 4. 保留mips32el核心参数：-mips32 -EL
          mipsel-linux-gnu-gcc -mips32 -EL -O2 -fPIC -shared \
            src/*.c libretro.c -Iinc -o quicknes_libretro.so -lm -Wall
          
          # 验证编译结果
          echo "=== 编译产物信息 ==="
          ls -la quicknes_libretro.so  # 确认文件生成
          file quicknes_libretro.so    # 确认架构是mips32小端

      - name: Upload compiled core
        uses: actions/upload-artifact@v4
        with:
          name: quicknes-libretro-mips32el
          path: QuickNES_Core/quicknes_libretro.so
          retention-days: 30
