name: Build pcsx_rearmed for GCW0 (Direct Make)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          wget \
          tar \
          gzip \
          libsdl1.2-dev \
          zlib1g-dev \
          libpng-dev
          
    - name: Setup GCW0 toolchain
      run: |
        sudo mkdir -p /opt
        sudo chmod 777 /opt
        
        cd /opt
        wget -q https://github.com/game-de-it/GKD_pixel/releases/download/GKDpixel-toolchain-v1/mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz
        tar zxf mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz
        mv mipsel-gcw0-linux-uclibc_sdk-buildroot gcw0-toolchain
        cd gcw0-toolchain
        ./relocate-sdk.sh
        
        # 设置环境变量
        export CC=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-gcc
        export CXX=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-g++
        export AR=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-ar
        export LD=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-ld
        export STRIP=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-strip
        export RANLIB=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-ranlib
        
        # 设置编译标志
        export CFLAGS="-ffast-math -march=mips32 -mtune=mips32r2 -mhard-float -fdata-sections -ffunction-sections -O2"
        export CXXFLAGS="$CFLAGS"
        export LDFLAGS="-Wl,--gc-sections"
        
        echo "CC=$CC" >> $GITHUB_ENV
        echo "CXX=$CXX" >> $GITHUB_ENV
        echo "AR=$AR" >> $GITHUB_ENV
        echo "LD=$LD" >> $GITHUB_ENV
        echo "STRIP=$STRIP" >> $GITHUB_ENV
        echo "RANLIB=$RANLIB" >> $GITHUB_ENV
        echo "CFLAGS=$CFLAGS" >> $GITHUB_ENV
        echo "CXXFLAGS=$CXXFLAGS" >> $GITHUB_ENV
        echo "LDFLAGS=$LDFLAGS" >> $GITHUB_ENV
        
    - name: Clone and build pcsx_rearmed
      run: |
        # 克隆pcsx_rearmed
        git clone https://github.com/notaz/pcsx_rearmed.git
        cd pcsx_rearmed
        
        # 应用GCW0特定的补丁或配置（如果需要）
        # 这里可以根据需要添加GCW0特定的配置
        
        # 配置和编译
        ./configure --platform=gcw0 --sound-drivers=sdl
        
        # 编译
        make
        
        # 如果是libretro版本
        # make -f Makefile.libretro platform=gcw0
        
    - name: Create release package
      run: |
        mkdir -p release
        cp pcsx_rearmed/pcsx_rearmed release/ || true
        cp pcsx_rearmed/pcsx_rearmed_libretro.so release/ || true
        
        # 创建readme文件
        echo "PCSX ReARMed for GCW0/GKD Pixel" > release/README.txt
        echo "Built on: $(date)" >> release/README.txt
        echo "Toolchain: GCW0 SDK" >> release/README.txt
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pcsx-rearmed-gcw0
        path: release/
