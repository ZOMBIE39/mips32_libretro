# 工作流名称，会显示在GitHub Actions页面
name: Build mips32el libretro core

# 触发条件：推送到main分支时自动运行，也支持手动触发
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 手动触发开关

# 定义编译任务
jobs:
  build:
    # 运行环境：Ubuntu 22.04（LTS版，依赖更稳定）
    runs-on: ubuntu-22.04
    
    steps:
      # 步骤1：拉取仓库代码（空仓库也需要这一步初始化环境）
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：安装mips32el交叉编译工具链和依赖
      - name: Install cross-compiler and dependencies
        run: |
          # 更新软件源
          sudo apt update -y
          # 安装mips32el交叉编译工具链（核心）
          sudo apt install -y gcc-mipsel-linux-gnu g++-mipsel-linux-gnu
          # 安装编译libretro核心所需的基础依赖
          sudo apt install -y make git build-essential libsdl2-dev

      # 步骤3：拉取libretro核心源码（以fbneo为例，可替换为其他核心）
      - name: Clone libretro core source code
        run: |
          # 克隆fbneo核心源码（其他核心可替换此仓库地址）
          git clone https://github.com/libretro/FBNeo.git libretro-fbneo
          cd libretro-fbneo
          # 进入libretro编译目录（大部分核心都有这个目录）
          cd src/burner/libretro

      # 步骤4：交叉编译mips32el架构的libretro核心
      - name: Cross compile for mips32el
        run: |
          cd libretro-fbneo/src/burner/libretro
          # 设置交叉编译工具链前缀
          export CC=mipsel-linux-gnu-gcc
          export CXX=mipsel-linux-gnu-g++
          # 编译：指定架构为mips32，小端，优化等级O2，生成.so文件
          make -j$(nproc) \
            platform=libretro \
            ARCH=mips \
            CPU=mips32 \
            ENDIANNESS=little \
            CFLAGS="-mips32 -EL -O2" \
            CXXFLAGS="-mips32 -EL -O2" \
            LDFLAGS="-mips32 -EL"
          # 验证编译产物的架构（可选，用于确认是否为mips32el）
          file fbneo_libretro.so

      # 步骤5：上传编译产物（方便下载）
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          # 产物名称，下载时会显示
          name: fbneo-libretro-mips32el
          # 编译产物的路径
          path: libretro-fbneo/src/burner/libretro/fbneo_libretro.so
