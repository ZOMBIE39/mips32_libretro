# 工作流名称
name: Build pcsx_rearmed for GCW0 (mipsel)

# 触发条件：手动触发、push/main分支推送、pull request
on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# 运行环境
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：设置Ubuntu环境，安装必要依赖（wget、tar等）
      - name: Install system dependencies
        run: |
          sudo apt update && sudo apt install -y wget tar make gcc git

      # 步骤2：下载并配置指定的工具链
      - name: Download and setup GCW0 toolchain
        run: |
          # 创建/opt目录（确保存在），下载工具链压缩包
          sudo mkdir -p /opt
          wget https://github.com/game-de-it/GKD_pixel/releases/download/GKDpixel-toolchain-v1/mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz -O /tmp/toolchain.tar.gz
          
          # 解压到/opt目录（需要sudo权限）
          sudo tar zxvf /tmp/toolchain.tar.gz -C /opt/
          
          # 重命名工具链目录（保持和手动操作一致）
          sudo mv /opt/mipsel-gcw0-linux-uclibc_sdk-buildroot /opt/gcw0-toolchain
          
          # 执行relocate-sdk.sh（修复路径）
          cd /opt/gcw0-toolchain
          sudo chmod +x relocate-sdk.sh
          sudo ./relocate-sdk.sh
          
          # 修改工具链目录权限，避免后续编译权限问题
          sudo chown -R $USER:$USER /opt/gcw0-toolchain

      # 步骤3：配置环境变量（对应手动修改.bashrc的内容）
      - name: Set environment variables
        run: |
          echo "CROSS_COMPILE=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-" >> $GITHUB_ENV
          echo "SYSROOT=/opt/gcw0-toolchain/usr/mipsel-gcw0-linux-uclibc/sysroot" >> $GITHUB_ENV
          echo "CC=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-gcc" >> $GITHUB_ENV
          echo "CXX=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-g++" >> $GITHUB_ENV
          echo "AR=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-ar" >> $GITHUB_ENV
          echo "LD=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-ld" >> $GITHUB_ENV
          # 设置编译FLAGS
          echo "CFLAGS=-ffast-math -march=mips32 -mtune=mips32r2 -mhard-float -fdata-sections -ffunction-sections" >> $GITHUB_ENV
          echo "CXXFLAGS=-ffast-math -march=mips32 -mtune=mips32r2 -mhard-float -fdata-sections -ffunction-sections" >> $GITHUB_ENV

      # 步骤4：检出pcsx_rearmed源码（替换为你实际的仓库地址）
      - name: Checkout pcsx_rearmed source code
        uses: actions/checkout@v4
        with:
          repository: libretro/pcsx_rearmed  # 默认使用libretro官方仓库，可替换为你的fork
          path: pcsx_rearmed
          fetch-depth: 1

      # 步骤5：编译pcsx_rearmed核心（适配libretro核心编译方式）
      - name: Build pcsx_rearmed core
        run: |
          cd pcsx_rearmed
          # 执行编译（Makefile.libretro是pcsx_rearmed的libretro核心编译文件）
          make -f Makefile.libretro CROSS_COMPILE=${{ env.CROSS_COMPILE }} CC=${{ env.CC }} CXX=${{ env.CXX }} AR=${{ env.AR }} LD=${{ env.LD }} CFLAGS="${{ env.CFLAGS }}" CXXFLAGS="${{ env.CXXFLAGS }}"

      # 步骤6：上传编译产物（方便下载）
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pcsx_rearmed-gcw0-core
          path: pcsx_rearmed/pcsx_rearmed_libretro.so  # 编译后的核心文件路径
          retention-days: 30  # 产物保留30天
