name: Build pcsx_rearmed for GCW0 (mipsel)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install system dependencies
        run: |
          sudo apt update && sudo apt install -y wget tar make gcc git autoconf automake libtool pkg-config

      - name: Download and setup GCW0 toolchain
        run: |
          sudo mkdir -p /opt
          wget https://github.com/game-de-it/GKD_pixel/releases/download/GKDpixel-toolchain-v1/mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz -O /tmp/toolchain.tar.gz
          sudo tar zxvf /tmp/toolchain.tar.gz -C /opt/
          sudo mv /opt/mipsel-gcw0-linux-uclibc_sdk-buildroot /opt/gcw0-toolchain
          cd /opt/gcw0-toolchain
          sudo chmod +x relocate-sdk.sh
          sudo ./relocate-sdk.sh
          sudo chown -R $USER:$USER /opt/gcw0-toolchain

      - name: Set environment variables
        run: |
          echo "CROSS_COMPILE=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-" >> $GITHUB_ENV
          echo "SYSROOT=/opt/gcw0-toolchain/usr/mipsel-gcw0-linux-uclibc/sysroot" >> $GITHUB_ENV
          echo "CC=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-gcc" >> $GITHUB_ENV
          echo "CXX=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-g++" >> $GITHUB_ENV
          echo "AR=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-ar" >> $GITHUB_ENV
          echo "LD=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-ld" >> $GITHUB_ENV
          echo "CFLAGS=-ffast-math -march=mips32 -mtune=mips32r2 -mhard-float -fdata-sections -ffunction-sections --sysroot=${{ env.SYSROOT }}" >> $GITHUB_ENV
          echo "CXXFLAGS=-ffast-math -march=mips32 -mtune=mips32r2 -mhard-float -fdata-sections -ffunction-sections --sysroot=${{ env.SYSROOT }}" >> $GITHUB_ENV
          # 新增：导出工具链PATH，确保辅助工具能被找到
          echo "/opt/gcw0-toolchain/usr/bin" >> $GITHUB_PATH

      - name: Checkout pcsx_rearmed source code
        uses: actions/checkout@v4
        with:
          repository: libretro/pcsx_rearmed  # 替换为你的仓库
          path: pcsx_rearmed
          fetch-depth: 1

      - name: Generate config.h (关键修复步骤)
        run: |
          cd pcsx_rearmed
          # 步骤1：生成configure脚本（如果缺失）
          if [ ! -f configure ]; then
            ./autogen.sh
          fi
          # 步骤2：运行configure生成config.h，适配GCW0/mipsel平台
          ./configure \
            --host=mipsel-gcw0-linux-uclibc \
            --prefix=/usr \
            --sysconfdir=/etc \
            --disable-sdl \
            --disable-alsa \
            --enable-libretro \
            CC=${{ env.CC }} \
            CXX=${{ env.CXX }} \
            CFLAGS="${{ env.CFLAGS }}" \
            CXXFLAGS="${{ env.CXXFLAGS }}"

      - name: Build pcsx_rearmed core (适配GCW0)
        run: |
          cd pcsx_rearmed
          # 清理旧编译产物，避免冲突
          make -f Makefile.libretro clean
          # 编译，新增PLATFORM参数指定unix，适配mipsel架构
          make -f Makefile.libretro \
            PLATFORM=unix \
            ARCH=mipsel \
            CROSS_COMPILE=${{ env.CROSS_COMPILE }} \
            CC=${{ env.CC }} \
            CXX=${{ env.CXX }} \
            AR=${{ env.AR }} \
            LD=${{ env.LD }} \
            CFLAGS="${{ env.CFLAGS }}" \
            CXXFLAGS="${{ env.CXXFLAGS }}" \
            -j$(nproc)  # 多线程编译加速

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pcsx_rearmed-gcw0-core
          path: pcsx_rearmed/pcsx_rearmed_libretro.so
          retention-days: 30
