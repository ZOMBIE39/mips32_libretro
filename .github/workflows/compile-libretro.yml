name: Build pcsx_rearmed for GCW0

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          wget \
          tar \
          gzip \
          libsdl1.2-dev \
          libsdl2-dev \
          zlib1g-dev \
          libpng-dev \
          libvorbis-dev \
          libflac-dev \
          libmpg123-dev \
          libmad0-dev
          
    - name: Setup GCW0 toolchain
      run: |
        # 创建/opt目录并设置权限
        sudo mkdir -p /opt
        sudo chmod 777 /opt
        
        # 下载工具链
        cd /opt
        wget https://github.com/game-de-it/GKD_pixel/releases/download/GKDpixel-toolchain-v1/mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz
        
        # 解压工具链
        tar zxvf mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz
        
        # 重命名工具链目录（为了兼容性）
        mv mipsel-gcw0-linux-uclibc_sdk-buildroot gcw0-toolchain
        
        # 运行重定位脚本
        cd gcw0-toolchain
        ./relocate-sdk.sh
        
        # 设置环境变量
        echo "CROSS_COMPILE=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-" >> $GITHUB_ENV
        echo "SYSROOT=/opt/gcw0-toolchain/usr/mipsel-gcw0-linux-uclibc/sysroot" >> $GITHUB_ENV
        echo "CC=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-gcc" >> $GITHUB_ENV
        echo "CXX=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-g++" >> $GITHUB_ENV
        echo "AR=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-ar" >> $GITHUB_ENV
        echo "LD=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-ld" >> $GITHUB_ENV
        echo "PATH=/opt/gcw0-toolchain/usr/bin:$PATH" >> $GITHUB_ENV
        
        # 设置编译标志
        echo "CFLAGS=-ffast-math -march=mips32 -mtune=mips32r2 -mhard-float -fdata-sections -ffunction-sections" >> $GITHUB_ENV
        echo "CXXFLAGS=-ffast-math -march=mips32 -mtune=mips32r2 -mhard-float -fdata-sections -ffunction-sections" >> $GITHUB_ENV
        
    - name: Clone pcsx_rearmed repository
      run: |
        git clone https://github.com/libretro/pcsx_rearmed.git
        cd pcsx_rearmed
        git submodule update --init
        
    - name: Build pcsx_rearmed
      run: |
        cd pcsx_rearmed
        # 使用libretro构建系统
        make -f Makefile.libretro platform=gcw0
        
    - name: Verify the build
      run: |
        cd pcsx_rearmed
        file pcsx_rearmed_libretro.so
        echo "Build completed successfully!"
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pcsx_rearmed-gcw0
        path: pcsx_rearmed/pcsx_rearmed_libretro.so
