name: Build mips32el libretro core

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cross-compiler and dependencies
        run: |
          sudo apt update -y
          # 安装完整的依赖（包含fbneo/fceumm所需的所有基础库）
          sudo apt install -y gcc-mipsel-linux-gnu g++-mipsel-linux-gnu \
            make git build-essential libsdl2-dev zlib1g-dev libpng-dev

      # 方案1：先编译fceumm（兼容性最好，验证环境），注释掉可换fbneo
      - name: Clone fceumm core (stable for test)
        run: |
          git clone https://github.com/libretro/libretro-fceumm.git libretro-fceumm
          # 验证目录是否存在
          ls -l libretro-fceumm/Makefile || echo "Makefile not found!"

      # 方案2：编译fbneo（需特殊适配），取消注释即可启用
      # - name: Clone fbneo core
      #   run: |
      #     git clone https://github.com/libretro/FBNeo.git libretro-fbneo
      #     ls -l libretro-fbneo/src/burner/libretro/Makefile || echo "Makefile not found!"

      - name: Cross compile fceumm for mips32el (stable)
        run: |
          # 开启详细日志，出错立即停止（便于排查）
          set -ex
          cd libretro-fceumm
          # 配置交叉编译工具链（核心参数）
          export CC=mipsel-linux-gnu-gcc
          export CXX=mipsel-linux-gnu-g++
          export AR=mipsel-linux-gnu-ar
          export LD=mipsel-linux-gnu-ld
          # 编译fceumm：仅保留核心架构参数（fceumm不识别自定义参数）
          make -j$(nproc) \
            platform=unix \
            ARCH=mips32 \
            CFLAGS="-mips32 -EL -O2 -mhard-float" \
            CXXFLAGS="-mips32 -EL -O2 -mhard-float" \
            LDFLAGS="-mips32 -EL"
          # 验证编译产物（关键：确认架构是mips32小端）
          file fceumm_libretro.so
          # 列出产物信息
          ls -lh fceumm_libretro.so

      # 适配fbneo的编译步骤（需取消注释）
      # - name: Cross compile fbneo for mips32el
      #   run: |
      #     set -ex
      #     cd libretro-fbneo/src/burner/libretro
      #     export CC=mipsel-linux-gnu-gcc
      #     export CXX=mipsel-linux-gnu-g++
      #     # fbneo的Makefile仅需指定编译器和架构参数，无需自定义ENDIANNESS
      #     make -j$(nproc) \
      #       TARGET=mips \
      #       CFLAGS="-mips32 -EL -O2 -DNDEBUG" \
      #       CXXFLAGS="-mips32 -EL -O2 -DNDEBUG" \
      #       LDFLAGS="-mips32 -EL"
      #     file fbneo_libretro.so

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: fceumm-libretro-mips32el
          path: libretro-fceumm/fceumm_libretro.so
          # 若编译fbneo，替换为：
          # path: libretro-fbneo/src/burner/libretro/fbneo_libretro.so
