name: Build pcsx_rearmed for GCW0 (mipsel)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install system dependencies
        run: |
          sudo apt update && sudo apt install -y wget tar make gcc git libmagic1 file binutils

      - name: Download and setup GCW0 toolchain
        run: |
          sudo mkdir -p /opt
          wget https://github.com/game-de-it/GKD_pixel/releases/download/GKDpixel-toolchain-v1/mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz -O /tmp/toolchain.tar.gz
          sudo tar zxvf /tmp/toolchain.tar.gz -C /opt/
          sudo mv /opt/mipsel-gcw0-linux-uclibc_sdk-buildroot /opt/gcw0-toolchain
          cd /opt/gcw0-toolchain
          sudo chmod +x relocate-sdk.sh
          sudo ./relocate-sdk.sh
          sudo chown -R $USER:$USER /opt/gcw0-toolchain
          # 验证工具链可用性
          /opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-gcc --version || echo "工具链可能存在问题，但继续执行"

      - name: Set environment variables
        run: |
          export CROSS_COMPILE=/opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-
          export SYSROOT=/opt/gcw0-toolchain/usr/mipsel-gcw0-linux-uclibc/sysroot
          export CC=${CROSS_COMPILE}gcc
          export CXX=${CROSS_COMPILE}g++
          export AR=${CROSS_COMPILE}ar
          export LD=${CROSS_COMPILE}ld
          export STRIP=${CROSS_COMPILE}strip
          # 关键修复：
          # 1. -include stdio.h 强制包含标准IO头文件，解决FILE类型未定义
          # 2. -DNO_ARM_FEATURES 跳过ARM架构头文件包含
          # 3. 补充所有必要的包含路径和宏定义
          export CFLAGS="-include stdio.h -I. -I./libpcsxcore -I./plugins -I./include -DMAXPATHLEN=4096 -DNO_ARM_FEATURES -DMIPS_ARCH=1 -march=mips32r2 -mtune=mips32r2 -mhard-float -mabi=32 -ffast-math -O2 -fPIC -D__mips__=1 -D__mipsel__=1 -DMIPS32=1 -DMIPS_HARD_FLOAT=1"
          export CXXFLAGS="${CFLAGS}"
          # 补充LDFLAGS：链接标准库，解决函数未定义
          export LDFLAGS="-shared -fPIC -Wl,--no-gc-sections -Wl,-z,now -Wl,-z,relro --sysroot=${SYSROOT} -lm -lpthread -ldl"
          
          echo "CROSS_COMPILE=$CROSS_COMPILE" >> $GITHUB_ENV
          echo "SYSROOT=$SYSROOT" >> $GITHUB_ENV
          echo "CC=$CC" >> $GITHUB_ENV
          echo "CXX=$CXX" >> $GITHUB_ENV
          echo "AR=$AR" >> $GITHUB_ENV
          echo "LD=$LD" >> $GITHUB_ENV
          echo "STRIP=$STRIP" >> $GITHUB_ENV
          echo "CFLAGS=$CFLAGS" >> $GITHUB_ENV
          echo "CXXFLAGS=$CXXFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=$LDFLAGS" >> $GITHUB_ENV
          echo "/opt/gcw0-toolchain/usr/bin" >> $GITHUB_PATH

      - name: Checkout pcsx_rearmed source code
        uses: actions/checkout@v4
        with:
          repository: libretro/pcsx_rearmed
          path: pcsx_rearmed
          fetch-depth: 0  # 关键：完整克隆，获取git版本信息（避免revision.h生成失败）

      - name: Patch source files to remove ARM dependencies and fix REV macro
        run: |
          # 先验证目录存在性
          if [ ! -d "pcsx_rearmed" ]; then
            echo "ERROR: pcsx_rearmed目录不存在！"
            exit 1
          fi
          cd pcsx_rearmed
          # 移除cdrom.c中对arm_features.h的包含（MIPS架构不需要）
          sed -i '/#include "arm_features.h"/d' libpcsxcore/cdrom.c || echo "未找到arm_features.h包含语句，跳过"
          # 确保psxcommon.h包含必要的标准头文件
          sed -i '1i #include <stdio.h>' libpcsxcore/psxcommon.h
          sed -i '1i #include <stdlib.h>' libpcsxcore/psxcommon.h
          sed -i '1i #include <string.h>' libpcsxcore/psxcommon.h
          # ========== 新增：修复misc.c中的REV宏引用 ==========
          # 将REV替换为GIT_VERSION（兼容宏定义）
          sed -i 's/REV/GIT_VERSION/g' libpcsxcore/misc.c
          echo "✅ 已修补源码：移除ARM依赖 + 修复REV宏引用"

      - name: Generate missing revision.h file (补充REV宏定义)
        run: |
          cd pcsx_rearmed
          # 创建include目录（如果不存在）
          mkdir -p include
          # 手动生成revision.h，包含REV宏定义（核心修复）
          cat > include/revision.h << EOF
          #ifndef REVISION_H
          #define REVISION_H
          #define GIT_VERSION "32e2193b"
          #define REV GIT_VERSION  // 关键：添加REV宏，匹配源码引用
          #define BUILD_DATE "__DATE__ __TIME__"
          #endif // REVISION_H
          EOF
          # 同时在源码根目录也生成一份（兼容不同的包含路径）
          cp include/revision.h ./revision.h
          echo "✅ 已手动生成revision.h文件（包含REV宏定义）"

      - name: Verify critical header files exist
        run: |
          cd pcsx_rearmed
          # 检查核心头文件是否存在
          if [ ! -f libpcsxcore/psemu_plugin_defs.h ]; then
            echo "ERROR: psemu_plugin_defs.h 缺失！"
            # 尝试从源码目录查找并复制
            find . -name "psemu_plugin_defs.h" -type f
            # 如果找到则复制到libpcsxcore目录
            find . -name "psemu_plugin_defs.h" -type f -exec cp {} libpcsxcore/ \;
          fi
          # 验证revision.h是否存在且包含REV宏
          if [ ! -f include/revision.h ] || [ ! -f revision.h ]; then
            echo "ERROR: revision.h生成失败！"
            exit 1
          fi
          grep -q "REV" include/revision.h || echo "WARNING: revision.h中未找到REV宏定义"
          ls -lh libpcsxcore/psemu_plugin_defs.h include/revision.h revision.h || echo "部分头文件缺失，继续尝试编译"

      - name: Generate complete config.h (补充核心宏定义)
        run: |
          cd pcsx_rearmed
          cat > config.h << EOF
          // 基础架构定义
          #define ARCH_MIPS 1
          #define ARCH_MIPSEL 1
          #define __mips__ 1
          #define __mipsel__ 1
          #define MIPS32 1
          #define MIPS32R2 1
          #define MIPS_HARD_FLOAT 1
          #define __mips_abi_hard 1
          #define MIPS_ARCH 1
          
          // 系统路径宏定义
          #define MAXPATHLEN 4096
          #define PATH_MAX 4096
          
          // 标准库支持（解决FILE/stdio函数问题）
          #define HAVE_STDIO_H 1
          #define HAVE_STDLIB_H 1
          #define HAVE_STRING_H 1
          #define HAVE_UNISTD_H 1
          #define HAVE_SYS_TYPES_H 1
          #define HAVE_SYS_STAT_H 1
          #define HAVE_SYS_PARAM_H 1
          #define HAVE_LIMITS_H 1
          #define HAVE_SYS_MMAN_H 1
          #define HAVE_PTHREAD_H 1
          
          // 禁用ARM架构特性
          #define NO_ARM_FEATURES 1
          #undef ARM_ARCH
          
          // Libretro核心必需定义
          #define HAVE_LIBRETRO 1
          #define LIBRETRO_API __attribute__((visibility("default")))
          
          // 功能模块启用
          #define HAVE_DYNAREC 1
          #define DYNAREC_MIPS 1
          #define DYNAREC_LIGHTREC 1
          #define DYNAREC_NONE 0
          #define GPU_PEOPS 1
          #define GPU_PEOPS_MIPS 1
          #define SOUND_DRIVER_SDL 1
          #define SOUND_DRIVER_NONE 0
          #define DISABLE_THREADS 0
          #define HAVE_THREADS 1
          
          // 函数支持
          #define HAVE_MEMCPY 1
          #define HAVE_MEMSET 1
          #define HAVE_MEMMOVE 1
          #define HAVE_STRCMP 1
          #define HAVE_STRNCMP 1
          #define HAVE_STRCASECMP 1
          #define HAVE_STRDUP 1
          #define HAVE_STRERROR 1
          #define HAVE_VSNPRINTF 1
          #define HAVE_PRINTF 1
          #define HAVE_SNPRINTF 1
          #define HAVE_MALLOC 1
          #define HAVE_FREE 1
          #define HAVE_REALLOC 1
          
          // 工具链路径
          #define SYSROOT "${{ env.SYSROOT }}"
          #define CROSS_COMPILE "${{ env.CROSS_COMPILE }}"
          
          // 编译优化
          #define HAVE_GCC_ATOMICS 1
          #define HAVE_GCC_BUILTINS 1
          #define HAVE_INLINE 1
          #define PACKAGE_VERSION "gcw0-20260106"
          #define VERSION "gcw0-20260106"
          EOF
          
          # 关键验证：确认文件存在且路径正确
          if [ ! -f config.h ]; then
            echo "ERROR: 生成config.h失败！"
            exit 1
          fi
          echo "✅ config.h 生成成功，路径：$(pwd)/config.h"
          ls -lh config.h

      - name: Pre-build verification
        run: |
          cd pcsx_rearmed
          # 确认config.h和修补后的源码存在
          if [ ! -f config.h ]; then exit 1; fi
          if grep -q "arm_features.h" libpcsxcore/cdrom.c; then
            echo "WARNING: ARM头文件包含未移除，但继续执行"
          fi
          # 验证misc.c中的REV已替换为GIT_VERSION
          grep -q "REV" libpcsxcore/misc.c && echo "WARNING: misc.c中仍存在REV引用" || echo "✅ misc.c中REV已替换为GIT_VERSION"
          echo "✅ 预编译验证通过"

      - name: Build pcsx_rearmed libretro core
        run: |
          cd pcsx_rearmed
          # 彻底清理旧产物
          make -f Makefile.libretro clean || rm -f pcsx_rearmed_libretro.so
          # 编译（降低并行数，避免编译错误）
          make -f Makefile.libretro \
            PLATFORM=unix \
            ARCH=mipsel \
            CROSS_COMPILE=${{ env.CROSS_COMPILE }} \
            CC=${{ env.CC }} \
            CXX=${{ env.CXX }} \
            AR=${{ env.AR }} \
            LD=${{ env.LD }} \
            CFLAGS="${{ env.CFLAGS }}" \
            CXXFLAGS="${{ env.CXXFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}" \
            HAVE_DYNAREC=1 \
            DYNAREC=lightrec \
            GPU=peops \
            SOUND=null \
            HAVE_THREADS=0 \
            -j1
          # 可选strip
          ${{ env.STRIP }} --strip-unneeded pcsx_rearmed_libretro.so || echo "strip失败，跳过"

      - name: Verify build result
        run: |
          cd pcsx_rearmed
          if [ -f pcsx_rearmed_libretro.so ]; then
            echo "✅ 编译成功！"
            ls -lh pcsx_rearmed_libretro.so
            file pcsx_rearmed_libretro.so
          else
            echo "ERROR: 编译产物缺失！"
            exit 1
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pcsx_rearmed-gcw0-core
          path: pcsx_rearmed/pcsx_rearmed_libretro.so
          retention-days: 30
