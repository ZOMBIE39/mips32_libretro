name: Build pcsx_rearmed for GCW0 (mipsel)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install system dependencies
        run: |
          sudo apt update && sudo apt install -y \
            wget tar make gcc git \
            libmagic1 libtool autoconf automake \
            libglib2.0-dev libsdl1.2-dev zlib1g-dev

      - name: Download and setup GCW0 toolchain
        run: |
          sudo mkdir -p /opt
          wget https://github.com/game-de-it/GKD_pixel/releases/download/GKDpixel-toolchain-v1/mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz -O /tmp/toolchain.tar.gz
          sudo tar zxvf /tmp/toolchain.tar.gz -C /opt/
          sudo mv /opt/mipsel-gcw0-linux-uclibc_sdk-buildroot /opt/gcw0-toolchain
          cd /opt/gcw0-toolchain
          sudo chmod +x relocate-sdk.sh
          sudo ./relocate-sdk.sh
          sudo chown -R $USER:$USER /opt/gcw0-toolchain

      - name: Set environment variables
        run: |
          export TOOLCHAIN_PATH=/opt/gcw0-toolchain/usr
          export CROSS_COMPILE=${TOOLCHAIN_PATH}/bin/mipsel-gcw0-linux-uclibc-
          export SYSROOT=${TOOLCHAIN_PATH}/mipsel-gcw0-linux-uclibc/sysroot
          export PATH=${TOOLCHAIN_PATH}/bin:${PATH}
          export CC=${CROSS_COMPILE}gcc
          export CXX=${CROSS_COMPILE}g++
          export AR=${CROSS_COMPILE}ar
          export LD=${CROSS_COMPILE}ld
          export STRIP=${CROSS_COMPILE}strip
          export RANLIB=${CROSS_COMPILE}ranlib
          export CFLAGS="-march=mips32 -mtune=mips32r2 -mhard-float -O2 -ffast-math -fdata-sections -ffunction-sections -I${SYSROOT}/usr/include"
          export CXXFLAGS="${CFLAGS}"
          export LDFLAGS="-L${SYSROOT}/usr/lib -Wl,--gc-sections"
          
          echo "TOOLCHAIN_PATH=$TOOLCHAIN_PATH" >> $GITHUB_ENV
          echo "CROSS_COMPILE=$CROSS_COMPILE" >> $GITHUB_ENV
          echo "SYSROOT=$SYSROOT" >> $GITHUB_ENV
          echo "CC=$CC" >> $GITHUB_ENV
          echo "CXX=$CXX" >> $GITHUB_ENV
          echo "AR=$AR" >> $GITHUB_ENV
          echo "LD=$LD" >> $GITHUB_ENV
          echo "STRIP=$STRIP" >> $GITHUB_ENV
          echo "CFLAGS=$CFLAGS" >> $GITHUB_ENV
          echo "CXXFLAGS=$CXXFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=$LDFLAGS" >> $GITHUB_ENV
          echo "PATH=${TOOLCHAIN_PATH}/bin:${PATH}" >> $GITHUB_ENV

      - name: Checkout pcsx_rearmed source code
        uses: actions/checkout@v4
        with:
          repository: libretro/pcsx_rearmed
          path: pcsx_rearmed
          fetch-depth: 1

      - name: Apply GCW0 specific patches
        run: |
          cd pcsx_rearmed
          # 创建适用于GCW0的配置文件
          cat > platform.mk << 'EOF'
          # GCW0平台特定配置
          CC = $(CROSS_COMPILE)gcc
          CXX = $(CROSS_COMPILE)g++
          AR = $(CROSS_COMPILE)ar
          STRIP = $(CROSS_COMPILE)strip
          RANLIB = $(CROSS_COMPILE)ranlib
          
          CFLAGS += -march=mips32 -mtune=mips32r2 -mhard-float -O2 -ffast-math -fdata-sections -ffunction-sections
          CXXFLAGS += $(CFLAGS)
          LDFLAGS += -Wl,--gc-sections
          
          # 启用必要的功能
          HAVE_DYNAREC = 1
          DYNAREC = lightrec
          GPU = peops
          SOUND_DRIVERS = sdl
          DISABLE_THREADS = 0
          EOF

      - name: Build pcsx_rearmed with proper configuration
        run: |
          cd pcsx_rearmed
          
          # 清理之前的构建
          make -f Makefile.libretro clean || true
          
          # 使用正确的配置构建
          make -f Makefile.libretro \
            platform=gcw0 \
            ARCH=mipsel \
            WITH_DYNAREC=lightrec \
            GPU_PEOPS=1 \
            BUILTIN_GPU=peops \
            CORE_DEFINES="-D__GCW0__ -DHAVE_LIGHTREC -DUSE_LIBRETRO_VFS" \
            CC="${{ env.CC }}" \
            CXX="${{ env.CXX }}" \
            AR="${{ env.AR }}" \
            LD="${{ env.LD }}" \
            CFLAGS="${{ env.CFLAGS }}" \
            CXXFLAGS="${{ env.CXXFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}" \
            -j$(nproc) \
            VERBOSE=1 2>&1 | tee build.log

      - name: Check build output and strip if needed
        run: |
          cd pcsx_rearmed
          
          if [ -f pcsx_rearmed_libretro.so ]; then
            echo "✅ 编译成功！原始文件大小:"
            ls -lh pcsx_rearmed_libretro.so
            
            # 如果文件太小（< 500KB），尝试其他配置
            FILESIZE=$(stat -c%s pcsx_rearmed_libretro.so)
            if [ $FILESIZE -lt 500000 ]; then
              echo "⚠️ 文件大小异常 ($FILESIZE 字节)，尝试备用构建方法..."
              
              # 方法1: 尝试使用不同的GPU后端
              make -f Makefile.libretro clean
              make -f Makefile.libretro \
                platform=gcw0 \
                ARCH=mipsel \
                WITH_DYNAREC=lightrec \
                GPU=unai \
                CORE_DEFINES="-D__GCW0__ -DHAVE_LIGHTREC" \
                -j$(nproc)
                
              if [ -f pcsx_rearmed_libretro.so ] && [ $(stat -c%s pcsx_rearmed_libretro.so) -gt 500000 ]; then
                echo "✅ 备用构建成功！文件大小正常。"
              else
                # 方法2: 尝试禁用动态重编译
                make -f Makefile.libretro clean
                make -f Makefile.libretro \
                  platform=gcw0 \
                  ARCH=mipsel \
                  WITH_DYNAREC=none \
                  GPU=peops \
                  -j$(nproc)
              fi
            fi
            
            # 最终检查
            if [ -f pcsx_rearmed_libretro.so ]; then
              FINAL_SIZE=$(stat -c%s pcsx_rearmed_libretro.so)
              echo "最终文件大小: $FINAL_SIZE 字节"
              
              # 检查文件类型
              echo "文件类型:"
              file pcsx_rearmed_libretro.so || true
              
              # 检查符号表
              echo "符号表检查:"
              ${CROSS_COMPILE}readelf -h pcsx_rearmed_libretro.so 2>/dev/null || true
            fi
          else
            echo "❌ 编译失败！找不到输出文件"
            echo "构建日志:"
            cat build.log 2>/dev/null || echo "没有构建日志"
            exit 1
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pcsx_rearmed-gcw0-core
          path: pcsx_rearmed/pcsx_rearmed_libretro.so
          retention-days: 30
