name: Build MIPS32 Little-Endian Core

# 触发条件：push 到主分支/标签，或 PR 到主分支
on:
  push:
    branches: [ main, master ]
    tags: [ '*' ]
  pull_request:
    branches: [ main, master ]

# 运行环境
jobs:
  build-mips32el:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取仓库源码
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive  # 拉取子模块（依赖库）

      # 2. 安装交叉编译工具链及依赖
      - name: Install MIPS32el Toolchain
        run: |
          sudo apt update && sudo apt install -y \
            gcc-mipsel-linux-gnu \
            g++-mipsel-linux-gnu \
            binutils-mipsel-linux-gnu \
            make git libtool pkg-config \
            build-essential

      # 3. 配置交叉编译环境变量
      - name: Set Compilation Env
        run: |
          echo "CROSS_COMPILE=mipsel-linux-gnu-" >> $GITHUB_ENV
          echo "CC=mipsel-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CXX=mipsel-linux-gnu-g++" >> $GITHUB_ENV
          echo "AR=mipsel-linux-gnu-ar" >> $GITHUB_ENV
          echo "RANLIB=mipsel-linux-gnu-ranlib" >> $GITHUB_ENV
          # MIPS32el 编译标志（禁用JIT、小端、软浮点）
          COMMON_FLAGS="-march=mips32 -mlittle-endian -mabi=32 -msoft-float -O2 -fomit-frame-pointer -ffast-math -DNO_JIT=1 -DDRC_DISABLE=1 -DMIPS=1"
          echo "CFLAGS=$COMMON_FLAGS" >> $GITHUB_ENV
          echo "CXXFLAGS=$COMMON_FLAGS -fno-rtti -fno-exceptions" >> $GITHUB_ENV
          echo "ASFLAGS=-march=mips32 -mlittle-endian -mabi=32" >> $GITHUB_ENV
          echo "LDFLAGS=-march=mips32 -mlittle-endian -mabi=32 -lm" >> $GITHUB_ENV

      # 4. 编译依赖库（zlib）
      - name: Build Zlib for MIPS32el
        run: |
          cd deps/libchdr/deps/zlib-1.3.1/
          ./configure --prefix=/tmp/mipsel-zlib --arch=mipsel --libdir=/tmp/mipsel-zlib/lib
          make CC="${{ env.CC }}" CFLAGS="${{ env.CFLAGS }}" LDFLAGS="${{ env.LDFLAGS }}" -j$(nproc)
          make install
          cd -

      # 5. 编译依赖库（zstd）
      - name: Build Zstd for MIPS32el
        run: |
          cd deps/libchdr/deps/zstd-1.5.6/
          make CC="${{ env.CC }}" CFLAGS="${{ env.CFLAGS }}" LDFLAGS="${{ env.LDFLAGS }}" -j$(nproc)
          cd -

      # 6. 编译 PCSX-ReARMed 核心（libretro 版本）
      - name: Build PCSX-ReARMed Core
        run: |
          # 清理旧产物
          make -f Makefile.libretro platform=unix clean
          # 编译核心
          make -f Makefile.libretro platform=unix -j$(nproc)
          # 验证产物架构
          file pcsx_rearmed_libretro.so

      # 7. 上传编译产物（保留90天）
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pcsx_rearmed-mips32el-core
          path: pcsx_rearmed_libretro.so
          retention-days: 90
