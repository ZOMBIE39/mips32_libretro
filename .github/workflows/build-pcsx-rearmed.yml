name: Build MIPS32 Little-Endian Core

# 触发条件：推送到主分支/特定分支、或PR指向这些分支时触发
on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master, dev ]

# 运行环境和作业定义
jobs:
  build-mips32el:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出代码（包含子模块，因为pcsx_rearmed有很多deps子模块）
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive  # 拉取所有子模块（deps/libchdr、deps/lightning等）

      # 步骤2：安装MIPS32小端交叉编译工具链和依赖
      - name: Install cross-compile toolchain & dependencies
        run: |
          sudo apt update
          # 安装MIPS32el交叉编译工具链（gcc-mipsel-linux-gnu）
          sudo apt install -y gcc-mipsel-linux-gnu g++-mipsel-linux-gnu \
                              make git cmake pkg-config libsdl2-dev

      # 步骤3：配置交叉编译环境，编译pcsx_rearmed
      - name: Cross compile for MIPS32 little-endian
        run: |
          # 定义交叉编译前缀（MIPS32小端工具链前缀）
          export CROSS_COMPILE=mipsel-linux-gnu-
          export CC=${CROSS_COMPILE}gcc
          export CXX=${CROSS_COMPILE}g++
          export AR=${CROSS_COMPILE}ar
          export LD=${CROSS_COMPILE}ld

          # 针对pcsx_rearmed的编译参数（适配MIPS32小端）
          # 注意：需根据pcsx_rearmed的Makefile调整PLATFORM/ARCH等参数
          cd pcsx_rearmed  # 若配置文件在根目录则无需cd
          make clean
          make \
            PLATFORM=generic \
            ARCH=mips32el \
            CFLAGS="-mips32 -EL -mabi=32 -O2" \
            LDFLAGS="-mips32 -EL" \
            -j$(nproc)

      # 步骤4：上传编译产物（核心文件）
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pcsx_rearmed-mips32el-core
          # 指定编译后的核心文件路径（需根据实际编译产物调整）
          path: |
            pcsx_rearmed/pcsx_rearmed.elf  # 示例产物路径，以实际为准
            pcsx_rearmed/libretro.so        # 若编译libretro核心，补充路径
