name: Build pcsx_rearmed for Dingux (mips32)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install build dependencies
        run: |
          sudo apt update && sudo apt install -y \
            git \
            build-essential \
            gcc-mipsel-linux-gnu \
            g++-mipsel-linux-gnu \
            libtool \
            autoconf \
            automake \
            pkg-config \
            make \
            cmake \
            python3 \
            wget \
            unzip

      - name: Clone libretro-super and fetch pcsx_rearmed source
        run: |
          # 克隆libretro-super仓库（深度设为1加快速度）
          git clone --depth=1 https://github.com/libretro/libretro-super.git
          cd libretro-super
          # 第一步：手动初始化并更新所有子模块（强制重试）
          git submodule sync --recursive
          git submodule update --init --recursive --force
          # 第二步：如果子模块仍未拉取，手动克隆pcsx_rearmed源码（兜底方案）
          if [ ! -d "libretro-pcsx_rearmed" ]; then
            echo "子模块拉取失败，手动克隆pcsx_rearmed源码..."
            git clone https://github.com/libretro/pcsx_rearmed.git libretro-pcsx_rearmed
          fi
          # 调试：打印子模块状态和目录结构
          echo "===== 子模块状态 ====="
          git submodule status
          echo "===== libretro-super目录结构 ====="
          ls -la
          echo "===== pcsx_rearmed目录是否存在 ====="
          if [ -d "libretro-pcsx_rearmed" ]; then
            echo "✅ libretro-pcsx_rearmed目录存在"
            ls -la libretro-pcsx_rearmed/
          else
            echo "❌ libretro-pcsx_rearmed目录不存在"
          fi

      - name: Set cross-compile env for Dingux mips32
        run: |
          echo "CC=mipsel-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CXX=mipsel-linux-gnu-g++" >> $GITHUB_ENV
          echo "AR=mipsel-linux-gnu-ar" >> $GITHUB_ENV
          echo "RANLIB=mipsel-linux-gnu-ranlib" >> $GITHUB_ENV
          echo "CFLAGS=-march=mips32 -mabi=32 -mtune=mips32 -O2 -fPIC -DDINGUX=1" >> $GITHUB_ENV
          echo "CXXFLAGS=-march=mips32 -mabi=32 -mtune=mips32 -O2 -fPIC -DDINGUX=1" >> $GITHUB_ENV
          echo "LDFLAGS=-march=mips32 -mabi=32 -mtune=mips32 -fPIC" >> $GITHUB_ENV
          env | grep -E "(CC|CXX|CFLAGS|DINGUX)"

      - name: Build pcsx_rearmed for Dingux mips32
        run: |
          cd libretro-super
          # 先确认源码目录存在再编译
          if [ ! -d "libretro-pcsx_rearmed" ]; then
            echo "❌ 源码目录不存在，编译终止"
            exit 1
          fi
          # 开启详细日志编译
          VERBOSE=1 ./libretro-build.sh pcsx_rearmed
          # 调试：查找.so文件
          echo "===== 查找所有编译生成的.so文件 ====="
          find . -name "*.so" -type f
          ls -la ./libretro-pcsx_rearmed/ || echo "libretro-pcsx_rearmed目录仍不存在"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pcsx_rearmed-dingux-mips32
          path: |
            libretro-super/libretro-pcsx_rearmed/pcsx_rearmed_libretro.so
            libretro-super/dist/unix/pcsx_rearmed_libretro.so
          retention-days: 30
          if-no-files-found: warn
