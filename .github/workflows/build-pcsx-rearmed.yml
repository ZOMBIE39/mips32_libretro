name: Build pcsx_rearmed for GKD Pixel (Dingux mips32)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install basic dependencies
        run: |
          sudo apt update && sudo apt install -y \
            git \
            build-essential \
            wget \
            tar \
            unzip \
            make \
            cmake \
            python3 \
            rsync \
            autoconf \
            automake \
            libtool # 补充生成config.h所需的autotools工具

      # 步骤1：部署GKD工具链（标准路径）
      - name: Deploy GKD pixel toolchain
        run: |
          sudo mkdir -p /opt/gcw0-toolchain
          sudo chmod 777 /opt/gcw0-toolchain
          wget -q https://github.com/game-de-it/GKD_pixel/releases/download/GKDpixel-toolchain-v1/mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz -O toolchain.tar.gz
          tar -xzf toolchain.tar.gz -C /opt/gcw0-toolchain --strip-components=1
          # 验证工具链
          TOOLCHAIN_BIN="/opt/gcw0-toolchain/usr/bin"
          if [ ! -f "$TOOLCHAIN_BIN/mipsel-gcw0-linux-uclibc-gcc" ]; then
            echo "❌ 工具链部署失败"
            exit 1
          fi
          echo "TOOLCHAIN_BIN=$TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "PATH=$TOOLCHAIN_BIN:$PATH" >> $GITHUB_PATH

      # 步骤2：克隆源码并确保子模块完整（含依赖）
      - name: Clone libretro-super & fetch pcsx_rearmed
        run: |
          git clone --depth=1 https://github.com/libretro/libretro-super.git
          cd libretro-super
          # 拉取pcsx_rearmed（含所有子模块依赖）
          if [ ! -d "libretro-pcsx_rearmed" ]; then
            git clone --recursive https://github.com/libretro/pcsx_rearmed.git libretro-pcsx_rearmed
          else
            cd libretro-pcsx_rearmed
            git submodule update --init --recursive # 确保依赖子模块（如lightning/lightrec）完整
          fi
          # 验证源码
          cd ../libretro-pcsx_rearmed
          [ -f "Makefile.libretro" ] && echo "✅ 源码及依赖完整" || (echo "❌ 源码缺失" && exit 1)

      # 步骤3：配置编译环境（对齐default.config）
      - name: Set compile env (GKD Pixel)
        run: |
          # 编译器配置
          echo "CC=mipsel-gcw0-linux-uclibc-gcc" >> $GITHUB_ENV
          echo "CXX=mipsel-gcw0-linux-uclibc-g++" >> $GITHUB_ENV
          echo "AR=mipsel-gcw0-linux-uclibc-ar" >> $GITHUB_ENV
          echo "RANLIB=mipsel-gcw0-linux-uclibc-ranlib" >> $GITHUB_ENV
          echo "STRIP=mipsel-gcw0-linux-uclibc-strip" >> $GITHUB_ENV
          
          # 核心编译参数（含sysroot）
          BASE_CFLAGS="-mips32 -mtune=mips32r2 -mhard-float -ffast-math -fomit-frame-pointer -O2 -fPIC -DDINGUX=1 -DGCW0=1 -DGKD_PIXEL=1"
          SYSROOT="--sysroot=/opt/gcw0-toolchain/target"
          echo "CFLAGS=$BASE_CFLAGS $SYSROOT" >> $GITHUB_ENV
          echo "CXXFLAGS=$BASE_CFLAGS $SYSROOT" >> $GITHUB_ENV
          echo "LDFLAGS=-mips32 -mtune=mips32r2 -mhard-float -fPIC -static-libgcc -Wl,--gc-sections $SYSROOT" >> $GITHUB_ENV

      # 步骤4：生成config.h（核心修复步骤）
      - name: Generate config.h for pcsx_rearmed
        run: |
          cd libretro-super/libretro-pcsx_rearmed
          # 步骤1：生成configure脚本（如果缺失）
          if [ ! -f "configure" ]; then
            autoreconf -fiv || echo "⚠️ autoreconf警告（非致命），继续"
          fi
          # 步骤2：运行configure生成config.h（适配GKD工具链）
          ./configure \
            --host=mipsel-gcw0-linux-uclibc \
            --prefix=/opt/gcw0-toolchain/target \
            --disable-sdl \
            --disable-alsa \
            --enable-libretro \
            CC="${{ env.CC }}" \
            CXX="${{ env.CXX }}" \
            CFLAGS="${{ env.CFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}"
          # 验证config.h是否生成
          if [ -f "config.h" ]; then
            echo "✅ config.h生成成功！"
            ls -lh config.h
          else
            echo "❌ config.h生成失败"
            exit 1
          fi

      # 步骤5：编译pcsx_rearmed（带config.h）
      - name: Build pcsx_rearmed (GKD Pixel)
        run: |
          cd libretro-super/libretro-pcsx_rearmed
          # 清理旧产物
          make -f Makefile.libretro clean || true
          # 手动编译（指定完整参数）
          VERBOSE=1 make -f Makefile.libretro \
            CC="${{ env.CC }}" \
            CXX="${{ env.CXX }}" \
            AR="${{ env.AR }}" \
            RANLIB="${{ env.RANLIB }}" \
            CFLAGS="${{ env.CFLAGS }}" \
            CXXFLAGS="${{ env.CXXFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}" \
            platform=dingux \
            ARCH=mipsel \
            DYNAREC=lightrec
          
          # 验证产物
          if [ -f "pcsx_rearmed_libretro.so" ]; then
            echo "✅ 编译成功！产物信息："
            file pcsx_rearmed_libretro.so
            ls -lh pcsx_rearmed_libretro.so
          else
            echo "❌ 编译失败，无产物生成"
            exit 1
          fi

      # 步骤6：上传产物
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pcsx_rearmed-gkd-pixel-mips32
          path: libretro-super/libretro-pcsx_rearmed/pcsx_rearmed_libretro.so
          retention-days: 30
          if-no-files-found: error
