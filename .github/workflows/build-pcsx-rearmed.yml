name: Build pcsx_rearmed for GCW0

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  TOOLCHAIN_URL: "https://github.com/game-de-it/GKD_pixel/releases/download/GKDpixel-toolchain-v1/mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz"
  TOOLCHAIN_DIR: "/opt/gcw0-toolchain"
  
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          wget \
          tar \
          gzip \
          bzip2 \
          python3 \
          make \
          cmake \
          autoconf \
          automake \
          libtool \
          pkg-config \
          libsdl2-dev \
          zlib1g-dev \
          libpng-dev \
          libvorbis-dev \
          libflac-dev \
          libmpg123-dev \
          nasm
          
    - name: Download and setup toolchain
      run: |
        sudo mkdir -p /opt
        sudo chmod 777 /opt
        
        cd /opt
        wget ${{ env.TOOLCHAIN_URL }}
        
        tar zxvf mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz
        
        mv mipsel-gcw0-linux-uclibc_sdk-buildroot gcw0-toolchain
        
        cd gcw0-toolchain
        ./relocate-sdk.sh
        
    - name: Set up environment variables
      run: |
        echo "CROSS_COMPILE=${{ env.TOOLCHAIN_DIR }}/usr/bin/mipsel-gcw0-linux-uclibc-" >> $GITHUB_ENV
        echo "SYSROOT=${{ env.TOOLCHAIN_DIR }}/usr/mipsel-gcw0-linux-uclibc/sysroot" >> $GITHUB_ENV
        echo "CC=${{ env.TOOLCHAIN_DIR }}/usr/bin/mipsel-gcw0-linux-uclibc-gcc" >> $GITHUB_ENV
        echo "CXX=${{ env.TOOLCHAIN_DIR }}/usr/bin/mipsel-gcw0-linux-uclibc-g++" >> $GITHUB_ENV
        echo "AR=${{ env.TOOLCHAIN_DIR }}/usr/bin/mipsel-gcw0-linux-uclibc-ar" >> $GITHUB_ENV
        echo "LD=${{ env.TOOLCHAIN_DIR }}/usr/bin/mipsel-gcw0-linux-uclibc-ld" >> $GITHUB_ENV
        echo "STRIP=${{ env.TOOLCHAIN_DIR }}/usr/bin/mipsel-gcw0-linux-uclibc-strip" >> $GITHUB_ENV
        echo "RANLIB=${{ env.TOOLCHAIN_DIR }}/usr/bin/mipsel-gcw0-linux-uclibc-ranlib" >> $GITHUB_ENV
        
        echo "CFLAGS=-ffast-math -march=mips32 -mtune=mips32r2 -mhard-float -fdata-sections -ffunction-sections" >> $GITHUB_ENV
        echo "CXXFLAGS=-ffast-math -march=mips32 -mtune=mips32r2 -mhard-float -fdata-sections -ffunction-sections" >> $GITHUB_ENV
        echo "LDFLAGS=-Wl,--gc-sections" >> $GITHUB_ENV
        
        echo "${{ env.TOOLCHAIN_DIR }}/usr/bin" >> $GITHUB_PATH
        
    - name: Clone pcsx_rearmed repository
      run: |
        git clone --depth=1 https://github.com/libretro/pcsx_rearmed.git
        cd pcsx_rearmed
        
    - name: Configure pcsx_rearmed
      run: |
        cd pcsx_rearmed
        
        # 首先运行configure脚本
        ./configure --platform=libretro
        
    - name: Build pcsx_rearmed
      run: |
        cd pcsx_rearmed
        
        # 设置环境变量
        export PATH="${{ env.TOOLCHAIN_DIR }}/usr/bin:$PATH"
        
        # 使用正确的编译命令
        # 方法1: 直接使用libretro的Makefile
        make -f Makefile.libretro platform=gcw0
        
    - name: Alternative build method (if above fails)
      if: failure()
      run: |
        cd pcsx_rearmed
        
        # 方法2: 使用交叉编译变量
        make -f Makefile.libretro \
          CC="${{ env.CC }}" \
          CXX="${{ env.CXX }}" \
          AR="${{ env.AR }}" \
          LD="${{ env.LD }}" \
          STRIP="${{ env.STRIP }}" \
          CFLAGS="${{ env.CFLAGS }}" \
          CXXFLAGS="${{ env.CXXFLAGS }}" \
          LDFLAGS="${{ env.LDFLAGS }}" \
          platform=gcw0
        
    - name: Check if binary was created
      run: |
        cd pcsx_rearmed
        if [ -f "pcsx_rearmed_libretro.so" ]; then
          echo "Build successful!"
          ls -la *.so
          
          # 检查文件类型
          file pcsx_rearmed_libretro.so
          
          # 检查文件大小
          du -h pcsx_rearmed_libretro.so
        else
          echo "Build failed - no .so file found"
          # 列出所有文件查看有什么
          ls -la
          exit 1
        fi
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pcsx_rearmed-gcw0
        path: pcsx_rearmed/pcsx_rearmed_libretro.so
        retention-days: 7
