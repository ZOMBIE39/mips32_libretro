name: Build pcsx_rearmed for GCW0

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup toolchain
      run: |
        sudo mkdir -p /opt
        sudo chmod 777 /opt
        cd /opt
        wget https://github.com/game-de-it/GKD_pixel/releases/download/GKDpixel-toolchain-v1/mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz
        tar zxvf mipsel-gcw0-linux-uclibc_sdk-buildroot.tar.gz
        mv mipsel-gcw0-linux-uclibc_sdk-buildroot gcw0-toolchain
        cd gcw0-toolchain
        ./relocate-sdk.sh
        
    - name: Setup environment
      run: |
        export TOOLCHAIN=/opt/gcw0-toolchain
        export PATH=$TOOLCHAIN/usr/bin:$PATH
        export CC=mipsel-gcw0-linux-uclibc-gcc
        export CXX=mipsel-gcw0-linux-uclibc-g++
        export AR=mipsel-gcw0-linux-uclibc-ar
        export LD=mipsel-gcw0-linux-uclibc-ld
        export STRIP=mipsel-gcw0-linux-uclibc-strip
        export RANLIB=mipsel-gcw0-linux-uclibc-ranlib
        
        echo "CC=$CC" >> $GITHUB_ENV
        echo "CXX=$CXX" >> $GITHUB_ENV
        echo "AR=$AR" >> $GITHUB_ENV
        echo "LD=$LD" >> $GITHUB_ENV
        echo "PATH=$PATH" >> $GITHUB_ENV
        echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
        
    - name: Clone and build pcsx_rearmed
      run: |
        git clone --depth=1 https://github.com/libretro/pcsx_rearmed.git
        cd pcsx_rearmed
        
        # 设置编译标志
        export CFLAGS="-ffast-math -march=mips32 -mtune=mips32r2 -mhard-float -fdata-sections -ffunction-sections"
        export CXXFLAGS="$CFLAGS"
        export LDFLAGS="-Wl,--gc-sections"
        
        # 编译
        make -f Makefile.libretro platform=gcw0
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pcsx-rearmed-core
        path: pcsx_rearmed/pcsx_rearmed_libretro.so
